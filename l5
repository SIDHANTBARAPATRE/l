import sagemaker
import boto3
import pandas as pd
import numpy as np
import os
from sklearn.datasets import make_classification
from sklearn.model_selection import train_test_split
from sagemaker.tuner import IntegerParameter, ContinuousParameter, HyperparameterTuner
from sagemaker.inputs import TrainingInput


session = sagemaker.Session()
role = sagemaker.get_execution_role()

bucket = 'lab3-data-bucket'
prefix = 'lab-hpo-xgboost'
region = boto3.Session().region_name

print(f"Region: {region}")
print(f"Bucket: {bucket}")


print("\nGenerating synthetic data...")
X, y = make_classification(n_samples=1000, n_features=20, random_state=42)


data = pd.DataFrame(X)
data.insert(0, 'target', y)


train_data, val_data = train_test_split(data, test_size=0.3, random_state=42)


train_data.to_csv('train.csv', header=False, index=False)
val_data.to_csv('validation.csv', header=False, index=False)


train_uri = session.upload_data('train.csv', bucket=bucket, key_prefix=f'/train')
val_uri = session.upload_data('validation.csv', bucket=bucket, key_prefix=f'/validation')

print("Data uploaded to S3.")


container = sagemaker.image_uris.retrieve("xgboost", region, "latest")


xgb = sagemaker.estimator.Estimator(
    image_uri=container,
    role=role,
    instance_count=1,
    instance_type='ml.m5.large',
    output_path=f's3://{bucket}/{prefix}/output',
    sagemaker_session=session
)


xgb.set_hyperparameters(
    objective='binary:logistic',
    num_round=50,
    eval_metric='auc'
)


hyperparameter_ranges = {
    'eta': ContinuousParameter(0.1, 0.5),           
    'max_depth': IntegerParameter(3, 9),           
    'min_child_weight': IntegerParameter(2, 6)      
}

# --- 5. Launch Hyperparameter Tuning Job ---
# Configure the Tuner
tuner = HyperparameterTuner(
    estimator=xgb,
    objective_metric_name='validation:auc',
    hyperparameter_ranges=hyperparameter_ranges,
    max_jobs=6,               
    max_parallel_jobs=2,      
    objective_type='Maximize' 
)


s3_input_train = TrainingInput(s3_data=train_uri, content_type='csv')
s3_input_validation = TrainingInput(s3_data=val_uri, content_type='csv')

print("\nStarting Hyperparameter Tuning Job...")
print("This will take approximately 5-8 minutes. Please wait.")


tuner.fit({'train': s3_input_train, 'validation': s3_input_validation})

tuner.wait()


best_job = tuner.best_training_job()


best_job_details = boto3.client('sagemaker').describe_training_job(TrainingJobName=best_job)
best_params = best_job_details['HyperParameters']
best_score = best_job_details['FinalMetricDataList'][0]['Value']

print("\n------------------------------------------------")
print(f"TUNING COMPLETE")
print(f"Best Training Job: {best_job}")
print(f"Best AUC Score:    {best_score}")
print("Best Hyperparameters Found:")
print(f" - eta:              {best_params.get('eta')}")
print(f" - max_depth:        {best_params.get('max_depth')}")
print(f" - min_child_weight: {best_params.get('min_child_weight')}")
print("------------------------------------------------")
